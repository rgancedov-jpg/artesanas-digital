<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Perfil Digital - Ministerio de la Mujer</title>
<!-- 
üöÄ Resumen de las Nuevas Funcionalidades
Esta versi√≥n consolida el formulario como una herramienta completa de gesti√≥n y difusi√≥n de perfiles (CRUD), integrando la base de datos (Firebase) y las utilidades de exportaci√≥n.
1. Funcionalidad de los Botones (CRUD y Utilidades)
Los botones permiten ejecutar las funciones principales de la aplicaci√≥n:
Bot√≥n	Acci√≥n Principal	Detalle y Objetivo
Buscar üîç	Lectura (Read)	Permite cargar el perfil mediante **b√∫squeda total o parcial** por Nombre de la Emprendedora, Nombre del Emprendimiento o Tel√©fono, facilitando la visualizaci√≥n o edici√≥n.
Guardar en BD	Creaci√≥n/Actualizaci√≥n (Create/Update)	Es el bot√≥n clave. Persiste los datos en Firestore y las im√°genes en Storage. Adem√°s, activa la generaci√≥n autom√°tica del C√≥digo Amigable si el perfil es nuevo.
Borrar Registro	Eliminaci√≥n (Delete)	Borra permanentemente el registro de la base de datos y elimina todas las im√°genes (logo y productos) asociadas de Firebase Storage.
Generar QR	Herramienta	Muestra en pantalla el C√≥digo QR interactivo, con opciones para incluir solo el link de Instagram o todos los datos del perfil.
Descargar PDF	Herramienta	Genera un PDF listo para imprimir que incluye todos los datos del perfil, las im√°genes y el C√≥digo QR.
Limpiar Filtro üîÑ	Herramienta	Restablece el formulario a un estado vac√≠o para un nuevo registro o limpia completamente los resultados de b√∫squeda, **ejecut√°ndose instant√°neamente sin mensajes de confirmaci√≥n**.
2. Otras Mejoras de la Versi√≥n
Implementaci√≥n de un algoritmo de **b√∫squeda flexible (total y parcial)** que ignora may√∫sculas/min√∫sculas y acentos, y realiza coincidencia de subcadenas en los campos clave (Nombre, Emprendimiento, Tel√©fono).
Reorganizaci√≥n del formulario para seguir el orden de captura solicitado (Artesana, Emprendimiento, Tel√©fono, Ubicaci√≥n, Logo, Descripci√≥n, Instagram).
Consolidaci√≥n del C√≥digo: Todo el proyecto (HTML, CSS y la l√≥gica de Firebase) est√° ahora contenido en un solo archivo para una gesti√≥n m√°s sencilla.
Mejora de Dise√±o en PDF: El logo del emprendimiento se muestra ahora m√°s grande y en una posici√≥n m√°s alta dentro del documento PDF, optimizando la visibilidad.
Previsualizaci√≥n de Archivos: Las im√°genes (logo y productos) se previsualizan instant√°neamente despu√©s de ser seleccionadas, mejorando la experiencia del usuario antes de subir a Firebase.
üì¶ Almacenamiento de im√°genes con Cloudinary
El formulario en index.html est√° preparado para que todas las im√°genes (logo y productos) se guarden en Cloudinary y no en Firebase Storage.
Configuraci√≥n necesaria en Cloudinary:
Cloud Name: djvnsgfcl
Upload Preset: perfil_artesana (debe estar configurado como unsigned).
Funcionamiento:
Al subir un archivo desde el formulario (logo, producto1, producto2), la funci√≥n uploadFileToCloudinary(file) env√≠a la imagen a Cloudinary.
Cloudinary responde con la URL p√∫blica segura (secure_url).
Esa URL se guarda en Firestore dentro del documento del perfil.
Ventajas de usar Cloudinary:
No necesitas configurar Firebase Storage.
Las im√°genes se entregan optimizadas y r√°pidas.
La base de datos en Firestore guarda √∫nicamente las URLs.
üìå Con esto, al hacer deploy a Firebase Hosting, tu app ya quedar√° funcionando con Firestore para datos y Cloudinary para im√°genes.
-->		
<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 2rem;
            background: #f9f9f9;
            text-align: left;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        h1, h2 {
            color: #4a148c; /* Violeta oscuro */
            font-size: 2.2rem;
            margin-bottom: 0.5rem;
            text-align: center;
        }
        h3 {
             color: #6a1b9a; /* Violeta medio */
             margin-top: 20px;
        }
        .subtitulo {
            color: #6a1b9a; /* Violeta medio */
            font-size: 1.2rem;
            margin-top: 0.2rem;
            text-align: center;
            margin-bottom: 1.5rem;
        }
        #headerLogoDisplay {
            text-align: center;
            margin-bottom: 20px;
        }
        #headerLogoDisplay img {
            max-width: 150px;
            height: auto;
        }
        form {
            background: #fff;
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
            max-width: 600px;
            width: 100%;
            box-sizing: border-box;
            text-align: left;
        }
        label {
            font-weight: bold;
            margin-top: 15px;
            display: block;
            color: #333;
        }
        input[type="text"], input[type="file"], input[type="email"], input[type="tel"], textarea {
            display: block;
            width: 100%;
            padding: 12px;
            margin: 8px 0;
            border-radius: 5px;
            border: 1px solid #ccc;
            box-sizing: border-box;
            text-align: left;
        }
        textarea {
            resize: vertical;
            min-height: 80px;
        }
        .btn-container {
            display: flex;
            gap: 10px;
            margin-top: 25px;
            justify-content: space-between;
            flex-wrap: wrap;
        }
        .btn {
            flex: 1;
            padding: 12px 20px;
            border: none;
            background-color: #6a1b9a; /* Violeta principal */
            color: white;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: background-color 0.3s;
            min-width: 100px;
        }
        .btn:hover {
            background-color: #4a148c; /* Violeta oscuro hover */
        }
        .btn-save {
            flex: 1;
            padding: 12px 20px;
            border: none;
            background-color: #28a745; /* Verde para guardar */
            color: white;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: background-color 0.3s;
            min-width: 100px;
        }
        .btn-save:hover { background-color: #198c3a; }
        
        .btn-delete {
            flex: 1;
            padding: 12px 20px;
            border: none;
            background-color: #dc3545; /* Rojo para borrar */
            color: white;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: background-color 0.3s;
            min-width: 100px;
        }
        .btn-delete:hover { background-color: #c82333; }

        .opciones {
            margin: 20px 0;
            padding: 15px;
            background: #f5f5f5;
            border-radius: 8px;
            border: 1px solid #ddd;
        }
        .opciones b {
            font-size: 1.1rem;
            color: #4a148c;
        }
        .opciones label {
            font-weight: normal;
            margin-top: 5px;
            color: #333;
            display: block;
        }
        .opciones input[type="radio"] {
            margin-right: 8px;
        }
        #qrDisplay {
            margin-top: 30px;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            max-width: 600px;
            width: 100%;
        }
        #qrCanvas {
            margin-top: 20px;
            padding: 15px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 12px;
            box-shadow: 0px 4px 8px rgba(0,0,0,0.1);
        }
        #qrMensaje {
            margin-top: 10px;
            font-weight: bold;
            color: #28a745;
        }
        .product-gallery {
            margin-top: 25px;
            padding: 15px;
            background: #f5f5f5;
            border-radius: 8px;
            border: 1px solid #ddd;
        }
        .preview-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
            justify-content: center;
        }
        .preview-item {
            border: 1px solid #ddd;
            padding: 5px;
            border-radius: 5px;
            background-color: #fff;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .preview-item img {
            max-width: 100px;
            max-height: 100px;
            margin-bottom: 5px;
        }
        .preview-item .description {
            font-size: 0.8rem;
            color: #555;
            text-align: center;
            width: 100%;
            word-wrap: break-word;
        }
    </style>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
        import { getFirestore, collection, addDoc, doc, updateDoc, getDoc, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";
        
        // =================================================================================
        // CONFIGURACI√ìN DE CLOUDINARY (Tu Cloud Name)
        // =================================================================================
        const CLOUDINARY_CLOUD_NAME = 'djvnsgfcl'; // ‚¨ÖÔ∏è ¬°Tu Cloud Name confirmado!
        const CLOUDINARY_UPLOAD_PRESET = 'perfil_artesana';  // ‚¨ÖÔ∏è Nombre del Preset que debes crear (Unsigned)
        // =================================================================================
        
        // =================================================================================
        // CONFIGURACI√ìN DE FIREBASE (Tomada del archivo subido)
        // =================================================================================
        const firebaseConfig = {
            apiKey: "AIzaSyAVzAro7RdogHAkW1R8VTjVpNhi7cCSXZY", 
            authDomain: "artesanas-panama-digital.firebaseapp.com", 
            projectId: "artesanas-panama-digital", 
            storageBucket: "artesanas-panama-digital.firebasestorage.app", 
            messagingSenderId: "216158084302", 
            appId: "1:216158084302:web:e3c38b4a1a7234c7a8449f", 
            measurementId: "G-SQPMWH7G50" 
        };
        // =================================================================================

        // Inicializar Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // ======================== FUNCI√ìN DE SUBIDA A CLOUDINARY ========================

        /**
         * Sube un archivo (imagen) a Cloudinary usando la API REST (Subida No Firmada).
         * @param {File} file El objeto de archivo (imagen) a subir.
         * @returns {Promise<string>} La URL p√∫blica de la imagen subida, o null si falla.
         */
        async function uploadFileToCloudinary(file) {
            if (!file) return null;
        
            const formData = new FormData();
            formData.append('file', file);
            formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
        
            const url = `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/upload`;
        
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('Error de subida a Cloudinary:', errorData);
                    alert(`‚ùå Cloudinary Error: ${errorData.error.message || response.statusText}. Revisa tu 'Upload Preset' y 'Cloud Name'.`);
                    return null;
                }
        
                const data = await response.json();
                
                // Retorna la URL segura de la imagen
                return data.secure_url; 
        
            } catch (error) {
                console.error('Error al subir la imagen:', error);
                alert(`‚ùå Error al subir la imagen a Cloudinary. Revisa tu conexi√≥n.`);
                return null; 
            }
        }

        // ======================== FUNCIONES AUXILIARES DE B√öSQUEDA Y DISPLAY ========================
        
        /**
         * Normaliza un n√∫mero de tel√©fono eliminando todos los caracteres que no sean d√≠gitos.
         */
        function normalizePhone(phone) {
            if (!phone) return '';
            return phone.replace(/\D/g, ''); 
        }

        /**
         * Limpia una cadena de texto, eliminando acentos y convirti√©ndola a min√∫sculas.
         */
        function cleanString(str) {
            if (!str) return '';
            return str.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase();
        }

        function llenarFormulario(data, docId) {
            document.getElementById("docId").value = docId || ""; 
            document.getElementById("nombre").value = data.nombre || "";
            document.getElementById("telefono").value = data.telefono || "";
            document.getElementById("ubicacion").value = data.ubicacion || "";
            document.getElementById("nombreEmprendimiento").value = data.nombreEmprendimiento || "";
            document.getElementById("descripcion").value = data.descripcion || "";
            document.getElementById("instagram").value = data.instagram || "";
            
            document.getElementById("descProducto1").value = data.productos?.[0]?.descripcion || "";
            document.getElementById("descProducto2").value = data.productos?.[1]?.descripcion || "";

            // ‚ö†Ô∏è NUEVO: Guardar las URLs de la base de datos en campos ocultos para uso en PDF
            document.getElementById("logoURL_db").value = data.logoURL || "";
            document.getElementById("producto1URL_db").value = data.productos?.[0]?.url || "";
            document.getElementById("producto2URL_db").value = data.productos?.[1]?.url || "";
            
            // LIMPIA LOS INPUTS TYPE="FILE" para forzar la resubida si se quiere cambiar la imagen
            document.getElementById("logo").value = null;
            document.getElementById("producto1").value = null;
            document.getElementById("producto2").value = null;

            // Mostrar el logo y productos existentes
            displayRemotePreviews(data);
        }
        
        /**
         * Muestra las previsualizaciones de im√°genes ya guardadas en Firestore (v√≠a URL).
         */
        function displayRemotePreviews(data) {
            const logoContainer = document.getElementById("logoPreview");
            const prodContainer = document.getElementById("productPreviews");
            logoContainer.innerHTML = "";
            prodContainer.innerHTML = "";

            // 1. Logo
            if (data.logoURL) {
                displayImageFromURL(data.logoURL, "Logo (Existente)", "logoPreview");
            }
            
            // 2. Productos
            const prod1 = data.productos?.[0];
            const prod2 = data.productos?.[1];

            if (prod1?.url) {
                 displayImageFromURL(prod1.url, prod1.descripcion || "Producto 1 (Existente)", "productPreviews");
            }
            if (prod2?.url) {
                 displayImageFromURL(prod2.url, prod2.descripcion || "Producto 2 (Existente)", "productPreviews");
            }
        }
        
        /**
         * Funci√≥n auxiliar para mostrar im√°genes desde una URL.
         */
        function displayImageFromURL(url, description, containerId) {
             const container = document.getElementById(containerId);
             const item = document.createElement("div");
             item.className = "preview-item";
             const img = document.createElement("img");
             img.src = url;
             img.alt = description;
             item.appendChild(img);
             const desc = document.createElement("p");
             desc.className = "description";
             desc.textContent = description;
             item.appendChild(desc);
             
             container.appendChild(item);
        }


        // ======================== FUNCIONES PRINCIPALES DE FIREBASE (CRUD) ========================

        // ** FUNCI√ìN CLAVE **: GUARDA O ACTUALIZA EN LA BASE DE DATOS
        window.guardarEnBD = async function () {
            const form = document.getElementById("dataForm");
            if (!form.checkValidity()) {
                form.reportValidity();
                alert("Por favor, rellene los campos obligatorios antes de guardar.");
                return;
            }

            const docId = document.getElementById("docId").value.trim(); 
            const nombre = document.getElementById("nombre").value.trim();
            const telefono = document.getElementById("telefono").value.trim();
                
            if (!nombre || !telefono) {
                alert("ERROR: Debe ingresar el Nombre y Tel√©fono.");
                return;
            }

            const ubicacion = document.getElementById("ubicacion").value.trim();
            const nombreEmprendimiento = document.getElementById("nombreEmprendimiento").value.trim();
            const descripcion = document.getElementById("descripcion").value.trim();
            const instagram = document.getElementById("instagram").value.trim();
            
            const btnGuardar = document.getElementById("btnGuardarBD");
            const originalText = btnGuardar ? btnGuardar.textContent : null;
            
            if (btnGuardar) {
                btnGuardar.disabled = true;
                btnGuardar.textContent = docId ? "Subiendo im√°genes y actualizando..." : "Subiendo im√°genes y guardando...";
            }

            // --- L√≥gica de im√°genes (ACTIVA CON CLOUDINARY) ---
            const logoFile = document.getElementById("logo").files[0];
            const producto1File = document.getElementById("producto1").files[0];
            const producto2File = document.getElementById("producto2").files[0];

            let logoURL = null;
            let producto1URL = null;
            let producto2URL = null;
            
            // OBTENER DATOS EXISTENTES PARA MANTENER LAS URLs SI NO SE SUBE UN ARCHIVO NUEVO
            let existingData = {};
            if (docId) {
                const docSnap = await getDoc(doc(db, "perfiles", docId));
                existingData = docSnap.exists() ? docSnap.data() : {};
                
                logoURL = existingData.logoURL || null;
                producto1URL = existingData.productos?.[0]?.url || null;
                producto2URL = existingData.productos?.[1]?.url || null;
            }
            
            // Subir solo si se seleccion√≥ un nuevo archivo, y actualizar la URL
            const uploadPromises = [
                logoFile ? uploadFileToCloudinary(logoFile) : Promise.resolve(logoURL),
                producto1File ? uploadFileToCloudinary(producto1File) : Promise.resolve(producto1URL),
                producto2File ? uploadFileToCloudinary(producto2File) : Promise.resolve(producto2URL),
            ];

            // Esperar que todas las subidas/resoluciones terminen
            [logoURL, producto1URL, producto2URL] = await Promise.all(uploadPromises);

            // Si alguna URL de imagen es null (fallo en la subida y no exist√≠a antes), lo manejamos.
            if (!logoURL && logoFile || (!producto1URL && producto1File) || (!producto2URL && producto2File)) {
                 if (btnGuardar) {
                     btnGuardar.disabled = false;
                     btnGuardar.textContent = originalText;
                 }
                 alert("‚ùå ERROR CR√çTICO: Una o m√°s subidas de im√°genes a Cloudinary fallaron. Revisa la consola y las credenciales.");
                 return;
            }
            // --- Fin L√≥gica de im√°genes ---

            try {
                const docData = {
                    nombre, telefono, ubicacion, nombreEmprendimiento, descripcion, instagram,
                    logoURL: logoURL || null, // Usa la URL de Cloudinary o null
                    productos: [
                        { url: producto1URL || null, descripcion: document.getElementById("descProducto1").value.trim() || null },
                        { url: producto2URL || null, descripcion: document.getElementById("descProducto2").value.trim() || null }
                    ],
                    // Campos adicionales para facilitar la b√∫squeda por texto (min√∫sculas)
                    nombre_lower: nombre.toLowerCase(),
                    nombreEmprendimiento_lower: nombreEmprendimiento.toLowerCase(),
                    updatedAt: new Date().toISOString()
                };
                
                let docRef;
                if (docId) {
                    docRef = doc(db, "perfiles", docId);
                    await updateDoc(docRef, docData);
                    alert("‚úÖ Registro actualizado (incluyendo im√°genes si fueron subidas) correctamente.");
                } else {
                    docRef = await addDoc(collection(db, "perfiles"), {
                        ...docData,
                        createdAt: new Date().toISOString()
                    });
                    document.getElementById("docId").value = docRef.id; 
                    alert("‚úÖ Datos guardados (incluyendo im√°genes) correctamente.");
                }

                generarQR();
                // Volver a cargar el formulario para ver las previsualizaciones actualizadas
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    llenarFormulario(docSnap.data(), docSnap.id);
                }

            } catch (err) {
                console.error("Error guardando en Firebase:", err);
                alert("‚ùå Ocurri√≥ un error al guardar en Firebase. Revisa la consola (F12).");
            } finally {
                if (btnGuardar) {
                    btnGuardar.disabled = false;
                    btnGuardar.textContent = originalText;
                }
            }
        };

        // ** FUNCI√ìN DE B√öSQUEDA (ACTUALIZADA con l√≥gica flexible) **
        window.buscarPorTexto = async function () {
            const textoBusqueda = document.getElementById("busquedaTexto").value.trim();
            
            if (!textoBusqueda) {
                alert("Por favor, ingrese el Nombre de la Emprendedora, Nombre del Emprendimiento o Tel√©fono para buscar.");
                return;
            }
            
            const btnBuscar = document.querySelector('button[onclick="buscarPorTexto()"]');
            const originalText = btnBuscar.textContent;
            btnBuscar.disabled = true;
            btnBuscar.textContent = "Buscando...";

            try {
                const profilesRef = collection(db, "perfiles");
                
                // 1. Preparamos los t√©rminos de b√∫squeda:
                const cleanSearch = cleanString(textoBusqueda); // "Mar√≠a Artesana" -> "maria artesana"
                const phoneSearchDigits = normalizePhone(textoBusqueda); // "Maria 654" -> "654"
                
                let querySnapshot = await getDocs(profilesRef);

                let docSnap = null;
                const docs = querySnapshot.docs;

                // B√∫squeda en el cliente: flexible con acentos y subcadenas
                for (const doc of docs) {
                    const data = doc.data();
                    
                    // Limpiamos los datos del documento para la comparaci√≥n:
                    const cleanNombre = cleanString(data.nombre);
                    const cleanEmprendimiento = cleanString(data.nombreEmprendimiento);
                    const normalizedTelefono = normalizePhone(data.telefono); // Siempre normalizado a d√≠gitos

                    // CRITERIO DE MATCH:
                    let match = false;
                    
                    // Criterio A: Coincidencia parcial en Nombre/Emprendimiento (con limpieza de acentos)
                    if (cleanNombre.includes(cleanSearch) || cleanEmprendimiento.includes(cleanSearch)) {
                        match = true;
                    }

                    // Criterio B: Coincidencia parcial de d√≠gitos en Tel√©fono (solo se eval√∫a si el t√©rmino tiene d√≠gitos)
                    if (!match && phoneSearchDigits.length > 0) { 
                        if (normalizedTelefono.includes(phoneSearchDigits)) {
                            match = true;
                        }
                    }

                    if (match) {
                        docSnap = doc;
                        break;
                    }
                }

                if (!docSnap) {
                    alert(`‚ùå No se encontr√≥ ning√∫n perfil que coincida con: ${textoBusqueda}. Puede crear uno nuevo.`);
                    document.getElementById("docId").value = ""; 
                    document.getElementById("dataForm").reset(); 
                    document.getElementById("busquedaTexto").value = textoBusqueda;
                    
                    // Asegurar que las previsualizaciones y QR se limpien
                    document.getElementById("logoPreview").innerHTML = ""; 
                    document.getElementById("productPreviews").innerHTML = ""; 
                    document.getElementById("qrCanvas").style.display = 'none'; 
                    document.getElementById("qrMensaje").textContent = ""; 
                    document.getElementById("logoURL_db").value = ""; // Limpiar campos ocultos
                    document.getElementById("producto1URL_db").value = "";
                    document.getElementById("producto2URL_db").value = "";
                    
                } else {
                    llenarFormulario(docSnap.data(), docSnap.id); 
                }

            } catch (error) {
                console.error("Error al buscar el documento:", error);
                alert("‚ùå Ocurri√≥ un error al intentar la b√∫squeda.");
            } finally {
                btnBuscar.disabled = false;
                btnBuscar.textContent = originalText;
            }
        };

        window.borrarArtesana = async function () {
            const docId = document.getElementById("docId").value.trim();

            if (!docId) {
                alert("‚ùå Error: No se ha cargado ning√∫n perfil para borrar. Use el bot√≥n 'Buscar' primero.");
                return;
            }

            // MENSAJE DE CONFIRMACI√ìN SIMPLE (SIN ID)
            if (!confirm(`‚ö†Ô∏è ¬øEst√° seguro que desea BORRAR PERMANENTEMENTE este registro? Esta acci√≥n es irreversible.`)) {
                return;
            }

            const btnBorrar = document.getElementById("btnBorrarBD");
            const originalText = btnBorrar.textContent;
            btnBorrar.disabled = true;
            btnBorrar.textContent = "Borrando...";

            try {
                const docRef = doc(db, "perfiles", docId);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    await deleteDoc(docRef); 

                    document.getElementById("dataForm").reset();
                    document.getElementById("docId").value = "";
                    // MENSAJE DE √âXITO SIMPLE (SIN ID)
                    alert(`‚úÖ El registro ha sido borrado exitosamente.`);
                } else {
                    alert("‚ùå Error: El documento no existe en Firestore, pero el formulario se ha limpiado.");
                    document.getElementById("dataForm").reset();
                    document.getElementById("docId").value = "";
                }

            } catch (error) {
                console.error("Error al borrar el registro:", error);
                alert(`‚ùå Ocurri√≥ un error al intentar borrar el registro: ${error.message}`);
            } finally {
                btnBorrar.disabled = false;
                btnBorrar.textContent = originalText;
            }
        };
        
        window.limpiarFormularioParaNuevoRegistro = function() {
            document.getElementById("dataForm").reset(); 
            document.getElementById("docId").value = ""; 
            document.getElementById("busquedaTexto").value = ""; 
            document.getElementById("logoPreview").innerHTML = ""; 
            document.getElementById("productPreviews").innerHTML = ""; 
            document.getElementById("qrCanvas").style.display = 'none'; 
            document.getElementById("qrMensaje").textContent = ""; 
            document.getElementById("logoURL_db").value = ""; // Limpiar campos ocultos
            document.getElementById("producto1URL_db").value = "";
            document.getElementById("producto2URL_db").value = "";
        }
        
        // ** FUNCI√ìN PARA LIMPIAR EL FILTRO DE B√öSQUEDA Y EL FORMULARIO **
        window.resetSearchFilter = function() {
            window.limpiarFormularioParaNuevoRegistro(); // Utiliza la funci√≥n existente para limpiar todo
        }

        // ======================== L√ìGICA DE QR Y PDF ========================
        const { jsPDF } = window.jspdf;
        
        /**
         * NUEVO: Obtiene la Data URL (base64) de la imagen, ya sea desde un archivo local o una URL remota.
         * @param {File} file El objeto de archivo local del input.
         * @param {string} url La URL remota (de Cloudinary) guardada en el campo oculto.
         * @returns {Promise<string|null>} La Data URL (base64) de la imagen para jsPDF.
         */
        async function getImageSourceForPDF(file, url) {
            if (file) {
                // Prioridad 1: Si hay un archivo local (nuevo), usarlo.
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => resolve(e.target.result);
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });
            } else if (url) {
                // Prioridad 2: Si no hay archivo local pero s√≠ hay URL remota, descargarla.
                try {
                    const response = await fetch(url);
                    if (!response.ok) throw new Error("Fallo al cargar la imagen de Cloudinary.");
                    const blob = await response.blob();
                    return new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = (e) => resolve(e.target.result);
                        reader.onerror = reject;
                        reader.readAsDataURL(blob);
                    });
                } catch (error) {
                    console.error("Error cargando imagen de URL para PDF:", error);
                    return null;
                }
            }
            return null;
        }

        function validarCampos() {
            const form = document.getElementById("dataForm");
            if (!form.checkValidity()) {
                form.reportValidity();
                return false;
            }
            return true;
        }

        function generarDatosQR() {
            const nombre = document.getElementById("nombre").value.trim();
            const telefono = document.getElementById("telefono").value.trim();
            const ubicacion = document.getElementById("ubicacion").value.trim();
            const nombreEmprendimiento = document.getElementById("nombreEmprendimiento").value.trim();
            const descripcion = document.getElementById("descripcion").value.trim();
            const instagramUser = document.getElementById("instagram").value.trim();
            const instagramUrl = `https://instagram.com/${instagramUser.replace('@', '')}`;
            const formato = document.querySelector('input[name="formatoQR"]:checked').value;

            if (formato === "1") {
                return instagramUrl;
            } else {
                return `
Nombre: ${nombre}
Tel√©fono: ${telefono}
Ubicaci√≥n: ${ubicacion}
Emprendimiento: ${nombreEmprendimiento}
Descripci√≥n: ${descripcion}
Instagram: ${instagramUser}
Link: ${instagramUrl}
                `;
            }
        }

        window.generarQR = function() {
            if (!validarCampos()) return;
            
            const datosQR = generarDatosQR();
            const qrCanvas = document.getElementById("qrCanvas");
            const qrMensaje = document.getElementById("qrMensaje");
            qrCanvas.style.display = 'none';

            QRCode.toCanvas(qrCanvas, datosQR, { width: 300 }, function (error) {
                if (error) {
                    qrMensaje.textContent = "Error al generar el QR.";
                } else {
                    qrMensaje.textContent = "QR generado correctamente ‚úÖ";
                    qrCanvas.style.display = 'block';
                }
            });
        }

        window.generarPDF = async function() {
            if (!validarCampos()) return;
            
            const qrCanvas = document.getElementById("qrCanvas");
            const qrMensaje = document.getElementById("qrMensaje");
            const datosQR = generarDatosQR();

            // 1. Generar QR para el PDF
            try {
                await new Promise((resolve, reject) => {
                    QRCode.toCanvas(qrCanvas, datosQR, { width: 300 }, function (error) {
                        if (error) reject("Error al generar el QR para el PDF.");
                        else resolve();
                    });
                });
                qrMensaje.textContent = "QR para PDF generado correctamente ‚úÖ";
            } catch (error) {
                alert(error);
                return;
            }
            
            // 2. Obtener datos del formulario
            const nombre = document.getElementById("nombre").value.trim();
            const telefono = document.getElementById("telefono").value.trim();
            const ubicacion = document.getElementById("ubicacion").value.trim();
            const nombreEmprendimiento = document.getElementById("nombreEmprendimiento").value.trim();
            const descripcion = document.getElementById("descripcion").value.trim();
            const instagramUser = document.getElementById("instagram").value.trim();
            const instagramUrl = `https://instagram.com/${instagramUser.replace('@', '')}`;
            
            // Referencias a inputs y campos ocultos
            const logoInput = document.getElementById("logo");
            const logoURL_db = document.getElementById("logoURL_db").value;
            const producto1Input = document.getElementById("producto1");
            const producto1URL_db = document.getElementById("producto1URL_db").value;
            const producto2Input = document.getElementById("producto2");
            const producto2URL_db = document.getElementById("producto2URL_db").value;
            const descProducto1 = document.getElementById("descProducto1").value.trim() || "Producto 1";
            const descProducto2 = document.getElementById("descProducto2").value.trim() || "Producto 2";
            
            const doc = new jsPDF();
            const qrImg = qrCanvas.toDataURL("image/png");
            const defaultLogoPdfUrl = document.getElementById("defaultLogo").src;

            // 3. Dise√±o del PDF (A4)
            if (defaultLogoPdfUrl) {
                doc.addImage(defaultLogoPdfUrl, "PNG", 20, 15, 30, 30);
            }

            doc.setFontSize(18);
            doc.setFont('helvetica', 'bold');
            doc.text("Ministerio de la Mujer", 60, 20);
            doc.setFontSize(12);
            doc.text("Impulsando a artesanas y emprendedoras hacia la transformaci√≥n digital", 60, 28);
            doc.setFontSize(14);
            doc.text("Perfil Digital - Artesanas y Emprendedoras", 60, 40);
            
            doc.addImage(qrImg, "PNG", 140, 50, 60, 60); 

            let yOffset = 55;
            doc.setFontSize(12);
            
            const addText = (title, content) => {
                doc.setFont('helvetica', 'bold');
                doc.text(title, 20, yOffset);
                doc.setFont('helvetica', 'normal');
                // Manejar texto largo
                const splitContent = doc.splitTextToSize(content, 110); // Ancho para el texto, dejando espacio para el QR
                doc.text(splitContent, 20, yOffset + 5);
                yOffset += (splitContent.length * 5) + 10;
            };

            addText(`Nombre de la Emprendedora: `, nombre);
            addText(`Tel√©fono: `, telefono);
            addText(`Ubicaci√≥n: `, ubicacion);
            yOffset += 5; // Espacio extra

            doc.setFont('helvetica', 'bold');
            doc.text(`Nombre del Emprendimiento: `, 20, yOffset);
            doc.setFont('helvetica', 'normal');
            doc.text(`${nombreEmprendimiento}`, 20, yOffset + 5);
            yOffset += 20;

            // 4. L√≥gica del Logo (Modificada para usar URL de DB)
            async function addLogo() {
                // Obtener la Data URL de la imagen (usa local file o URL de BD)
                const logoSource = await getImageSourceForPDF(logoInput.files[0], logoURL_db);
                
                if (logoSource) {
                    doc.setFont('helvetica', 'bold');
                    doc.text("Logo del Emprendimiento", 20, yOffset - 10); 
                    doc.setFont('helvetica', 'normal');
                    
                    const imgX = 20; 
                    const imgY = yOffset - 5; 
                    const imgWidth = 50; 
                    const imgHeight = 50; 
                    
                    doc.rect(imgX - 2, imgY - 2, imgWidth + 4, imgHeight + 4); 
                    
                    // Usar la Data URL obtenida
                    doc.addImage(logoSource, "JPEG", imgX, imgY, imgWidth, imgHeight); 
                    yOffset += 55; 
                }
            }

            function addMainText() {
                doc.setFont('helvetica', 'bold');
                doc.text(`Descripci√≥n: `, 20, yOffset);
                doc.setFont('helvetica', 'normal');
                
                const splitDescription = doc.splitTextToSize(descripcion, 170);
                doc.text(splitDescription, 20, yOffset + 5);
                yOffset += (splitDescription.length * 5) + 5;

                yOffset += 5; 
                
                doc.setFont('helvetica', 'bold');
                doc.text(`Instagram: `, 20, yOffset);
                doc.setFont('helvetica', 'normal');
                doc.text(instagramUser, 20, yOffset + 5);
                yOffset += 15;
                
                doc.setFont('helvetica', 'bold');
                doc.text(`Link: `, 20, yOffset);
                doc.setFont('helvetica', 'normal');
                doc.textWithLink(instagramUrl, 20, yOffset + 5, { url: instagramUrl });
                yOffset += 15;
            }

            // 5. L√≥gica de Productos (Modificada para usar URL de DB)
            async function addProducts() {
                doc.setFont('helvetica', 'bold');
                doc.text("Productos de Muestra", 20, yOffset);
                doc.setFont('helvetica', 'normal');

                const boxX = 18;
                const boxY = yOffset + 3;
                const boxWidth = 120;
                const boxHeight = 58;
                
                doc.rect(boxX, boxY, boxWidth, boxHeight); 
                yOffset += 10;
                
                // Funci√≥n auxiliar para agregar producto
                const addProductImage = async (fileInput, url_db, description, xOffset) => {
                    const imageSource = await getImageSourceForPDF(fileInput.files[0], url_db);

                    if (imageSource) {
                        const imgX = boxX + xOffset;
                        const imgY = yOffset + 1.5;                         
                        doc.addImage(imageSource, "JPEG", imgX, imgY, 40, 40);
                        
                        doc.setFontSize(8); 
                        doc.text(description, imgX + 20, imgY + 45, {align: 'center'}); 
                    }
                };
                
                // Esperar que ambos productos se carguen y se agreguen
                await addProductImage(producto1Input, producto1URL_db, descProducto1, 2);
                await addProductImage(producto2Input, producto2URL_db, descProducto2, 60);
                
                // A√±adir el espacio que ocupa la caja de productos
                yOffset += 65; 
            }

            try {
                await addLogo(); // Ahora usa la URL de BD si no hay archivo local
                addMainText();
                
                // Solo llama a la funci√≥n si hay alg√∫n dato de imagen disponible
                if (producto1Input.files[0] || producto2Input.files[0] || producto1URL_db || producto2URL_db) {
                    await addProducts(); // Ahora usa la URL de BD si no hay archivo local
                }

                doc.save(`${nombreEmprendimiento}_perfil.pdf`);
            } catch (err) {
                alert("Hubo un error al generar el PDF. Por favor, int√©ntelo de nuevo. (Revisa la consola F12 para detalles).");
                console.error(err);
            }
        }

        // ======================== L√ìGICA DE PREVISUALIZACI√ìN DE IM√ÅGENES LOCALES ========================

        function displayPreview(file, description, containerId) {
            const container = document.getElementById(containerId);
            const reader = new FileReader();
            reader.onload = function(e) {
                const item = document.createElement("div");
                item.className = "preview-item";
                const img = document.createElement("img");
                img.src = e.target.result;
                img.alt = description;
                item.appendChild(img);
                const desc = document.createElement("p");
                desc.className = "description";
                desc.textContent = description;
                item.appendChild(desc);
                
                document.getElementById(containerId).appendChild(item);
            };
            reader.readAsDataURL(file);
        }

        function updateProductPreviews() {
            const container = document.getElementById("productPreviews");
            container.innerHTML = ""; 
            const producto1Input = document.getElementById("producto1");
            const producto2Input = document.getElementById("producto2");
            const descProducto1 = document.getElementById("descProducto1").value.trim() || "Producto 1";
            const descProducto2 = document.getElementById("descProducto2").value.trim() || "Producto 2";

            if (producto1Input.files && producto1Input.files[0]) {
                displayPreview(producto1Input.files[0], descProducto1, "productPreviews");
            }
            if (producto2Input.files && producto2Input.files[0]) {
                displayPreview(producto2Input.files[0], descProducto2, "productPreviews");
            }
            // Esto asegura que si se est√° editando una descripci√≥n y no hay un archivo nuevo, se mantenga la previsualizaci√≥n existente.
            const data = {
                 logoURL: document.getElementById("logoURL_db").value,
                 productos: [
                     { url: document.getElementById("producto1URL_db").value, descripcion: document.getElementById("descProducto1").value.trim() },
                     { url: document.getElementById("producto2URL_db").value, descripcion: document.getElementById("descProducto2").value.trim() }
                 ]
            };
            // Vuelve a mostrar las previsualizaciones remotas si no hay archivos locales nuevos
            if (!producto1Input.files[0] || !producto2Input.files[0]) {
                 displayRemotePreviews(data);
            }
        }
        
        document.getElementById("logo").addEventListener("change", function() {
            const container = document.getElementById("logoPreview");
            container.innerHTML = ""; 
            if (this.files && this.files[0]) {
                displayPreview(this.files[0], "Logo del emprendimiento", "logoPreview");
            } else {
                 // Si se borra el archivo local, recupera la vista previa remota si existe
                 const data = { logoURL: document.getElementById("logoURL_db").value };
                 displayRemotePreviews(data);
            }
        });

        document.getElementById("producto1").addEventListener("change", updateProductPreviews);
        document.getElementById("descProducto1").addEventListener("input", updateProductPreviews);
        document.getElementById("producto2").addEventListener("change", updateProductPreviews);
        document.getElementById("descProducto2").addEventListener("input", updateProductPreviews);

        window.onload = function() {
            const defaultLogoImg = document.getElementById("defaultLogo");
            const headerLogoDisplay = document.getElementById("headerLogoDisplay");
            if (defaultLogoImg && headerLogoDisplay) {
                const imgClone = defaultLogoImg.cloneNode(true);
                imgClone.style.display = 'block';
                imgClone.style.maxWidth = '150px'; 
                imgClone.style.height = 'auto';
                headerLogoDisplay.appendChild(imgClone);
            }
            
            // Configurar el bot√≥n de reseteo de filtro/formulario
            document.getElementById("resetSearchButton").onclick = window.resetSearchFilter;
        };
    </script>
</head>
<body>
    <h1>Ministerio de la Mujer</h1>
    <p class="subtitulo">Impulsando a artesanas y emprendedoras hacia la transformaci√≥n digital</p>

    <div id="headerLogoDisplay"></div>
    
    <img id="defaultLogo" src="https://raw.githubusercontent.com/rgancedov-jpg/artesanas-digital/main/logo-nuevo-1_midem.png" alt="Logo de Ven Emprende" style="display: none;">

    <form id="dataForm">
        <section>
            <h3>Datos de la Emprendedora</h3>

            <input type="hidden" id="docId" value="" />
            <input type="hidden" id="logoURL_db" value="" />
            <input type="hidden" id="producto1URL_db" value="" />
            <input type="hidden" id="producto2URL_db" value="" />
            <label for="busquedaTexto">Buscar Perfil (Nombre, Emprendimiento o Tel√©fono)</label>
            <div style="display: flex; gap: 10px;">
                <input type="text" id="busquedaTexto" placeholder="Ej: Ana, Artesan√≠as, 6543-2109" style="flex-grow: 1;" />
                <button type="button" class="btn" onclick="buscarPorTexto()" style="min-width: 100px;">Buscar üîç</button>
                <button type="button" id="resetSearchButton" class="btn" style="min-width: 100px; background-color: #555; hover:background-color: #333;">Limpiar Filtro üîÑ</button>
            </div>
            <p style="font-size: 0.8rem; color: #555; margin-top: 5px;">*Busque **flexiblemente** por subcadenas en nombre de la emprendedora, emprendimiento o d√≠gitos del tel√©fono.</p>
            
            <label for="nombre">Nombre de la Emprendedora</label>
            <input type="text" id="nombre" value="Ana Mar√≠a Rodr√≠guez" required />

            <label for="nombreEmprendimiento">Nombre del emprendimiento</label>
            <input type="text" id="nombreEmprendimiento" value="Artesan√≠as Paname√±as" required />
            
            <label for="telefono">N√∫mero de Tel√©fono</label>
            <input type="text" id="telefono" value="6543-2109" required />

            <label for="ubicacion">Ubicaci√≥n del Emprendimiento</label>
            <input type="text" id="ubicacion" value="Ciudad de Panam√°, Panam√°" required />
        </section>

        <section>
            <label for="logo">Sube un logo diferente (opcional)</label>
            <input type="file" id="logo" accept="image/*" />
            <div id="logoPreview" class="preview-container"></div>
            
            <label for="descripcion">Descripci√≥n de sus productos</label>
            <textarea id="descripcion" required>Somos un emprendimiento que se especializa en la creaci√≥n de productos artesanales √∫nicos, inspirados en la rica cultura y tradiciones de Panam√°.</textarea>

            <label for="instagram">Instagram del negocio</label>
            <input type="text" id="instagram" value="@artesanias_panamenas" required />
        </section>

        <div class="product-gallery">
            <h3>Productos de Muestra</h3>
            <label for="producto1">Producto 1</label>
            <input type="file" id="producto1" accept="image/*" />
            <input type="text" id="descProducto1" placeholder="Descripci√≥n Producto 1" value="Bolso de fibra natural" />

            <label for="producto2">Producto 2</label>
            <input type="file" id="producto2" accept="image/*" />
            <input type="text" id="descProducto2" placeholder="Descripci√≥n Producto 2" value="Cuadro de arte Ember√°" />
        </div>
        
        <div id="productPreviews" class="preview-container"></div>
        
        <div class="opciones">
            <b>Formato del QR:</b><br>
            <label><input type="radio" name="formatoQR" value="1" checked> Solo Instagram directo</label><br>
            <label><input type="radio" name="formatoQR" value="2"> Todos los datos + Instagram</label>
        </div>
        
        <div class="btn-container">
            <button type="button" class="btn" onclick="limpiarFormularioParaNuevoRegistro()">Nuevo Perfil</button>
            <button type="button" class="btn" onclick="generarQR()">Generar QR</button>
            <button type="button" class="btn" onclick="generarPDF()">Descargar PDF</button>
            <button type="button" id="btnBorrarBD" class="btn-delete" onclick="borrarArtesana()">Borrar Registro</button>
            <button type="button" id="btnGuardarBD" class="btn-save" onclick="guardarEnBD()">Guardar en BD</button>
        </div>
    </form>

    <div id="qrDisplay">
        <canvas id="qrCanvas" style="display:none;"></canvas>
        <div id="qrMensaje"></div>
    </div>
</body>
</html>
