<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hist贸rico de Saldos Cripto (Firebase)</title>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* [Tu c贸digo CSS original] */
        body {
            font-family: Arial, sans-serif;
            background-color: #1a1a2e;
            color: #fff;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background-color: #272744;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
        }

        h1, h2 {
            text-align: center;
            color: #e0f7fa;
        }

        /* Secci贸n de Entrada de Datos - Mejorada */
        .input-section {
            display: flex;
            gap: 15px;
            margin: 20px 0;
            justify-content: center;
            align-items: flex-end;
            flex-wrap: wrap;
        }
        
        .input-group {
            display: flex;
            flex-direction: column;
        }

        .input-group label {
            margin-bottom: 5px;
            font-size: 0.9em;
            color: #ccc;
        }

        #saldoInput, #fechaInput {
            padding: 10px;
            border: none;
            border-radius: 5px;
            background-color: #3f3f6e;
            color: #fff;
            width: 150px;
        }

        /* Estilo para el input de fecha */
        #fechaInput[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(1);
        }

        button {
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            background-color: #00bcd4;
            color: #fff;
            cursor: pointer;
            transition: background-color 0.3s;
            height: 40px;
            margin-bottom: 3px;
        }

        button:hover {
            background-color: #0097a7;
        }
        
        /* Botones de la tabla */
        .action-button {
            padding: 5px 8px;
            margin: 0 2px;
            font-size: 0.8em;
            cursor: pointer;
        }

        .edit-btn { background-color: #ffc107; color: #1a1a2e; }
        .edit-btn:hover { background-color: #e0a800; }
        
        .delete-btn { background-color: #dc3545; }
        .delete-btn:hover { background-color: #c82333; }


        /* Notificaci贸n Autom谩tica (Toast) */
        #notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #4CAF50; /* Verde por defecto */
            color: white;
            padding: 12px 20px;
            border-radius: 5px;
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.3s, visibility 0.3s;
            z-index: 1000;
            min-width: 300px;
            text-align: center;
        }

        #notification.show {
            visibility: visible;
            opacity: 1;
        }
        
        #notification.error {
            background-color: #f44336; /* Rojo para errores */
        }
        
        /* Estilos para el porcentaje y delta de cambio (modificados de tu original) */
        .change-container {
            display: block; 
            font-size: 0.9em;
            margin-top: 4px;
        }
        
        .positive-change {
            color: #4CAF50; /* Verde */
            font-weight: bold;
        }

        .negative-change {
            color: #f44336; /* Rojo */
            font-weight: bold;
        }
        
        .no-change {
            color: #ccc;
        }


        /* Gr谩fica */
        .chart-container {
            height: 400px;
            margin-top: 30px;
            background-color: #1a1a2e;
            padding: 15px;
            border-radius: 8px;
        }

        /* Tabla de Hist贸rico */
        .table-container {
            margin-top: 40px;
        }

        #dataTable {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        #dataTable th, #dataTable td {
            padding: 12px;
            border-bottom: 1px solid #3f3f6e;
            text-align: left;
        }

        #dataTable th {
            background-color: #00bcd4;
            color: #1a1a2e;
        }
        
        /* Estilo para el modo edici贸n en la tabla */
        .editing {
            background-color: #3f3f6e !important;
        }
        .editing input {
            background-color: #4f4f7e;
            color: #fff;
            border: 1px solid #00bcd4;
            padding: 5px;
            width: 80%;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1> Hist贸rico de Saldo Total</h1>
        
        <div class="input-section">
            
            <div class="input-group">
                <label for="fechaInput">Fecha del Saldo:</label>
                <input type="date" id="fechaInput"> 
            </div>

            <div class="input-group">
                <label for="saldoInput">Saldo Total (USD):</label>
                <input type="text" id="saldoInput" placeholder="$1,234.56">
            </div>

            <button onclick="guardarSaldo()">Guardar Saldo</button>
        </div>

        <div id="notification"></div>

        <div class="chart-container">
            <h2> Comparativa Hist贸rica</h2>
            <canvas id="saldoChart"></canvas>
        </div>

        <div class="table-container">
            <h2> Hist贸rico de Datos</h2>
            <table id="dataTable">
                <thead>
                    <tr>
                        <th>Fecha</th>
                        <th>Saldo Total (USD) y Cambio (%)</th> <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    </tbody>
            </table>
        </div>
    </div>

    <script>
        // =======================================================
        // 1. CONFIGURACIN E INICIALIZACIN DE FIREBASE
        // =======================================================
        const firebaseConfig = {
            apiKey: "AIzaSyAVzAro7RdogHAkW1R8VTjVpNhi7cCSXZY", 
            authDomain: "artesanas-panama-digital.firebaseapp.com", 
            projectId: "artesanas-panama-digital", 
            storageBucket: "artesanas-panama-digital.firebasestorage.app", 
            messagingSenderId: "216158084302", 
            appId: "1:216158084302:web:e3c38b4a1a7234c7a8449f", 
            measurementId: "G-SQPMWH7G50" 
        };

        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        
        const db = firebase.firestore();

        // ** COLECCIN DE SALDOS (NUEVA COLECCIN) **
        const saldosCollection = db.collection("saldos_historicos"); 

        let historialSaldos = [];
        let chart;

        // =======================================================
        // FUNCIONES DE UTILIDAD
        // =======================================================
        function showNotification(message, isError = false) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            
            if (isError) {
                notification.classList.add('error');
            } else {
                notification.classList.remove('error');
            }
            
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        function getTodayDateString() {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function formatDisplayDate(dateString) {
            const date = new Date(dateString.replace(/-/g, '/'));
            const options = { day: 'numeric', month: 'short', year: 'numeric' };
            return isNaN(date) ? dateString : date.toLocaleDateString('es-ES', options); 
        }
        
        function formatNumberWithCommas(number) {
            return number.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        function calcularCambioPorcentual(saldoActual, saldoAnterior) {
            if (saldoAnterior === undefined || saldoAnterior === null || saldoAnterior === 0) {
                return { 
                    texto: '-', 
                    clase: 'no-change', 
                    porcentajeCrudo: null,
                    cambioAbsolutoTexto: '-' 
                };
            }
            
            const cambio = saldoActual - saldoAnterior;
            const porcentaje = (cambio / saldoAnterior) * 100;
            
            let texto;
            let clase;
            let cambioAbsolutoTexto;

            if (porcentaje > 0) {
                texto = `+${porcentaje.toFixed(2)}%`;
                clase = 'positive-change';
                cambioAbsolutoTexto = `+$${formatNumberWithCommas(cambio)}`;
            } else if (porcentaje < 0) {
                texto = `${porcentaje.toFixed(2)}%`;
                clase = 'negative-change';
                cambioAbsolutoTexto = `-$${formatNumberWithCommas(Math.abs(cambio))}`;
            } else {
                texto = '0.00%';
                clase = 'no-change';
                cambioAbsolutoTexto = '$0.00';
            }
            
            return { texto, clase, porcentajeCrudo: porcentaje, cambioAbsolutoTexto };
        }

        // =======================================================
        // FUNCIONES DE LECTURA (Cargan desde Firestore)
        // =======================================================
        async function cargarDatos() {
            try {
                const snapshot = await saldosCollection.get();
                historialSaldos = [];
                
                snapshot.forEach(doc => {
                    // El ID del documento es la fecha (YYYY-MM-DD), lo usamos para editar/eliminar
                    historialSaldos.push({ 
                        ...doc.data(), 
                        fecha: doc.id 
                    });
                });

            } catch (error) {
                console.error("Error al cargar datos de Firestore: ", error);
                showNotification("Error al cargar el hist贸rico de saldos desde Firebase.", true);
                historialSaldos = []; 
            }
            
            // 1. Ordena los datos por fecha
            historialSaldos.sort((a, b) => new Date(a.fecha) - new Date(b.fecha));

            // 2. Pre-calcular los porcentajes de cambio
            for (let i = 0; i < historialSaldos.length; i++) {
                const saldoActual = historialSaldos[i].saldo;
                const saldoAnterior = i > 0 ? historialSaldos[i - 1].saldo : null;
                
                const cambioData = calcularCambioPorcentual(saldoActual, saldoAnterior);
                
                historialSaldos[i].cambioTexto = cambioData.texto;
                historialSaldos[i].cambioClase = cambioData.clase;
                historialSaldos[i].cambioPorcentual = cambioData.porcentajeCrudo; 
                historialSaldos[i].cambioAbsolutoTexto = cambioData.cambioAbsolutoTexto;
            }

            actualizarTabla();
            actualizarGrafica();
        }

        // =======================================================
        // FUNCIONES DE ESCRITURA (Guardar, Editar, Eliminar)
        // =======================================================
        async function guardarSaldo() {
            const saldoInput = document.getElementById('saldoInput');
            const fechaInput = document.getElementById('fechaInput');
            
            let rawValue = saldoInput.value.trim();
            rawValue = rawValue.replace(/[$,\s]/g, ''); 
            rawValue = rawValue.replace(/,/g, '.'); 
            
            const saldo = parseFloat(rawValue);
            // Usamos la fecha como ID del documento en Firestore
            const fechaValor = fechaInput.value; 

            if (isNaN(saldo) || saldo <= 0) {
                showNotification("Por favor, ingresa un saldo v谩lido.", true);
                return;
            }
            if (!fechaValor) {
                showNotification("Por favor, ingresa una fecha v谩lida.", true);
                return;
            }

            const nuevoRegistro = {
                saldo: saldo // El campo fecha no es estrictamente necesario, ya que el ID es la fecha, pero lo mantenemos por consistencia
            };

            try {
                // .set() sobreescribe si el documento existe o lo crea si no existe
                await saldosCollection.doc(fechaValor).set(nuevoRegistro);
                
                showNotification(`Saldo para ${formatDisplayDate(fechaValor)} guardado/reemplazado con 茅xito en Firebase.`);
                
                saldoInput.value = '';
                fechaInput.value = getTodayDateString();
                await cargarDatos(); 
                
            } catch (error) {
                console.error("Error al guardar en Firestore: ", error);
                showNotification("Error al guardar en la base de datos.", true);
            }
        }

        async function guardarEdicion(index) {
            const oldRegistro = historialSaldos[index];
            const newFecha = document.getElementById(`edit-fecha-${index}`).value;
            const newSaldo = parseFloat(document.getElementById(`edit-saldo-${index}`).value);
            
            if (isNaN(newSaldo) || newSaldo <= 0) {
                showNotification("El saldo editado no es v谩lido.", true);
                return;
            }

            try {
                if (oldRegistro.fecha !== newFecha) {
                    // 1. Eliminar el registro antiguo
                    await saldosCollection.doc(oldRegistro.fecha).delete();
                    
                    // 2. Crear el nuevo registro con la nueva fecha como ID
                    await saldosCollection.doc(newFecha).set({ saldo: newSaldo });
                    showNotification(`Registro modificado y reubicado con 茅xito en Firebase.`);
                    
                } else {
                    // Solo actualizar el saldo del documento existente
                    await saldosCollection.doc(oldRegistro.fecha).update({ saldo: newSaldo });
                    showNotification(`Saldo modificado con 茅xito en Firebase.`);
                }
            } catch (error) {
                console.error("Error al guardar edici贸n en Firestore: ", error);
                showNotification("Error al guardar la edici贸n en la base de datos.", true);
            }
            
            await cargarDatos();
        }
        
        function cancelarEdicion(index) {
            cargarDatos();
            showNotification(`Edici贸n cancelada.`);
        }

        async function eliminarRegistro(index) {
            const registro = historialSaldos[index];
            const fechaAEliminar = formatDisplayDate(registro.fecha);
            
            if (confirm(`驴Est谩s seguro de que quieres eliminar el registro del ${fechaAEliminar}?`)) {
                try {
                    // Elimina el documento usando su ID (la fecha)
                    await saldosCollection.doc(registro.fecha).delete();
                    showNotification(`Registro del ${fechaAEliminar} eliminado de Firebase.`);
                } catch (error) {
                    console.error("Error al eliminar de Firestore: ", error);
                    showNotification("Error al eliminar el registro de la base de datos.", true);
                }
                await cargarDatos();
            }
        }

        // =======================================================
        // DIBUJO DE LA INTERFAZ (Sin cambios, usa historialSaldos)
        // =======================================================

        function actualizarTabla() {
            const tableBody = document.querySelector('#dataTable tbody');
            tableBody.innerHTML = '';
            
            historialSaldos.forEach((registro, index) => {
                const row = tableBody.insertRow();
                row.id = `row-${index}`; 
                
                // Celda 0: Fecha
                row.insertCell().textContent = formatDisplayDate(registro.fecha); 
                
                // Celda 1: Saldo, Delta $ y %
                const saldoCell = row.insertCell();
                
                const saldoFormateado = `$${formatNumberWithCommas(registro.saldo)}`;
                
                const cambioHTML = `
                    <span class="change-container ${registro.cambioClase}">
                        (${registro.cambioAbsolutoTexto} / ${registro.cambioTexto})
                    </span>
                `;
                
                saldoCell.innerHTML = `
                    <div>${saldoFormateado}</div>
                    ${registro.cambioAbsolutoTexto === '-' ? '' : cambioHTML}
                `;

                // Celda 2: Acciones
                const actionCell = row.insertCell();
                actionCell.innerHTML = `
                    <button class="action-button edit-btn" onclick="editarRegistro(${index})">Modificar</button>
                    <button class="action-button delete-btn" onclick="eliminarRegistro(${index})">Borrar</button>
                `;
            });
        }
        
        function editarRegistro(index) {
            const registro = historialSaldos[index];
            const row = document.getElementById(`row-${index}`);
            
            if (!row.classList.contains('editing')) {
                
                // Celda 0 (Fecha)
                row.cells[0].innerHTML = `<input type="date" id="edit-fecha-${index}" value="${registro.fecha}">`;
                
                // Celda 1 (Saldo)
                row.cells[1].innerHTML = `<input type="number" id="edit-saldo-${index}" value="${registro.saldo.toFixed(2)}" step="0.01">`;
                
                // Celda 2 (Acciones)
                row.cells[2].innerHTML = `
                    <button class="action-button edit-btn" onclick="guardarEdicion(${index})">Guardar</button>
                    <button class="action-button delete-btn" onclick="cancelarEdicion(${index})">Cancelar</button>
                `;
                
                row.classList.add('editing');
            }
        }
        
        function actualizarGrafica() {
            const ctx = document.getElementById('saldoChart').getContext('2d');
            
            const labels = historialSaldos.map(r => formatDisplayDate(r.fecha));
            const saldoData = historialSaldos.map(r => r.saldo);
            const cambioData = historialSaldos.map(r => r.cambioPorcentual);


            if (chart) {
                chart.destroy(); 
            }

            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Saldo Total (USD)',
                            data: saldoData,
                            borderColor: '#00bcd4',
                            backgroundColor: 'rgba(0, 188, 212, 0.2)',
                            borderWidth: 2,
                            tension: 0.3,
                            pointRadius: 5,
                            yAxisID: 'y1' 
                        },
                        {
                            label: 'Cambio % (vs Anterior)',
                            data: cambioData,
                            borderColor: '#ffc107',
                            backgroundColor: 'rgba(255, 193, 7, 0.2)',
                            borderWidth: 2,
                            tension: 0.3,
                            pointRadius: 5,
                            yAxisID: 'y2' 
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Saldo (USD)',
                                color: '#fff'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            ticks: {
                                color: '#fff',
                                callback: function(value, index, ticks) {
                                    return '$' + formatNumberWithCommas(value);
                                }
                            }
                        },
                        y2: { 
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Cambio (%)',
                                color: '#ffc107'
                            },
                            grid: {
                                drawOnChartArea: false, 
                                color: 'rgba(255, 193, 7, 0.1)'
                            },
                            ticks: {
                                color: '#ffc107',
                                callback: function(value, index, ticks) {
                                    return value.toFixed(1) + '%';
                                }
                            }
                        },
                        x: {
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            ticks: {
                                color: '#fff'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: {
                                color: '#fff'
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.dataset.yAxisID === 'y1' && context.parsed.y !== null) {
                                        label += '$' + formatNumberWithCommas(context.parsed.y);
                                    } else if (context.dataset.yAxisID === 'y2' && context.parsed.y !== null) {
                                        label += context.parsed.y.toFixed(2) + '%';
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // =======================================================
        // INICIALIZACIN (Usando async/await)
        // =======================================================
        window.onload = async function() {
            await cargarDatos();
            
            const fechaInput = document.getElementById('fechaInput');
            fechaInput.value = getTodayDateString();
        };
    </script>
</body>
</html>
