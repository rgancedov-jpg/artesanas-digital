<!DOCTYPE html>
<html lang="es">
<head> 
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Informe de Perfiles (Todo a 50 Ch.) - REAL TIME</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <script type="module">
        // Importa los m√≥dulos necesarios de Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
        import { getFirestore, collection, query, getDocs, orderBy } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

        // =================================================================================
        // CONFIGURACI√ìN DE FIREBASE (Tomada de administracion.html)
        // =================================================================================
        const firebaseConfig = {
            apiKey: "AIzaSyAVzAro7RdogHAkW1R8VTjVpNhi7cCSXZY", 
            authDomain: "artesanas-panama-digital.firebaseapp.com", 
            projectId: "artesanas-panama-digital", 
            storageBucket: "artesanas-panama-digital.firebasestorage.app", 
            messagingSenderId: "216158084302", 
            appId: "1:216158084302:web:e3c38b4a1a7234c7a8449f", 
            measurementId: "G-SQPMWH7G50" 
        };
        // =================================================================================

        // Inicializar Firebase y Firestore
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const perfilesRef = collection(db, "perfiles");

        const tableBody = document.getElementById('tableBody');
        const loadingIndicator = document.getElementById('loadingIndicator');
        
        /**
         * Funci√≥n para truncar el texto al l√≠mite de caracteres.
         */
        const DESC_LIMIT = 50; // L√≠mite uniforme para todos los campos de texto largo
        function truncateText(text, maxLength = DESC_LIMIT) {
            if (!text || text.length <= maxLength) {
                return text || 'N/A';
            }
            // Truncamos el texto al l√≠mite de caracteres y a√±adimos "..."
            return text.substring(0, maxLength) + '...';
        }
        
        /**
         * Funci√≥n principal para cargar todos los registros y generar la tabla.
         */
        window.loadAllRecordsAndDisplay = async function () {
            loadingIndicator.classList.remove('hidden');
            tableBody.innerHTML = '';
            
            try {
                // Ordenar alfab√©ticamente por 'nombre_lower' (Nombre de la Artesana)
                const q = query(perfilesRef, orderBy("nombre_lower", "asc")); 
                const querySnapshot = await getDocs(q);
                
                // Obtener y mostrar el total de registros cargados
                const recordCount = querySnapshot.size;
                document.getElementById('recordCountDisplay').textContent = recordCount;


                if (querySnapshot.empty) {
                    const row = tableBody.insertRow();
                    // Colspan ajustado de 9 a 10 para incluir la nueva columna N¬∞
                    row.insertCell(0).textContent = "No hay registros en la base de datos para mostrar.";
                    row.cells[0].colSpan = 10; 
                    row.cells[0].className = 'text-center py-6 text-gray-500 italic';
                    return;
                }
                
                let counter = 1; // üí° Nuevo contador para enumerar los registros
                
                querySnapshot.forEach(doc => {
                    const data = doc.data();
                    
                    const prod1 = data.productos?.[0];
                    const prod2 = data.productos?.[1];
                    
                    const row = tableBody.insertRow();
                    row.className = 'hover:bg-gray-50 transition-colors';
                    
                    // Columna 1: N¬∞ (N√∫mero de registro)
                    const numCell = row.insertCell();
                    numCell.textContent = counter++;
                    numCell.className = 'text-center font-bold text-gray-700';
                    
                    // Columna 2: Artesana Nombre
                    row.insertCell().textContent = data.nombre || 'N/A';
                    
                    // Columna 3: Emprendimiento Nombre
                    row.insertCell().textContent = data.nombreEmprendimiento || 'Sin Nombre';
                    
                    // Columna 4: Tel√©fono
                    row.insertCell().textContent = data.telefono || 'N/A';
                    
                    // Columna 5: Ubicaci√≥n (TRUNCADA a 50 caracteres)
                    row.insertCell().textContent = truncateText(data.ubicacion);
                    
                    // Columna 6: Instagram
                    row.insertCell().textContent = data.instagram || 'N/A';
                    
                    // Columna 7: Descripci√≥n (TRUNCADA a 50 caracteres)
                    row.insertCell().textContent = truncateText(data.descripcion);
                    // Columna 8: Producto 1 (Desc.) - TRUNCADA a 50 caracteres
                    row.insertCell().textContent = truncateText(prod1?.descripcion);
                    
                    // Columna 9: Producto 2 (Desc.) - TRUNCADA a 50 caracteres
                    row.insertCell().textContent = truncateText(prod2?.descripcion);
                    
                    // Columna 10: Fecha Creaci√≥n
                    row.insertCell().textContent = data.createdAt ? new Date(data.createdAt).toLocaleDateString() : 'N/A';
                });
                
            } catch (error) {
                console.error("Error al cargar registros desde Firestore:", error);
                const row = tableBody.insertRow();
                row.insertCell(0).textContent = `ERROR al conectar o cargar datos: ${error.message}`;
                row.cells[0].colSpan = 10; // Colspan ajustado a 10
                row.cells[0].className = 'text-center py-6 text-red-600 font-bold';
                document.getElementById('recordCountDisplay').textContent = 'ERROR';
            } finally {
                loadingIndicator.classList.add('hidden');
            }
        };
        
        window.onload = loadAllRecordsAndDisplay;
    </script>
    <style>
        /* Oculta el bot√≥n y el indicador de carga al imprimir */
        @media print {
            .no-print {
                display: none !important;
            }
            body {
                writing-mode: horizontal-tb;
                margin: 0;
                padding: 0;
                @page { size: landscape; } /* Forzar el modo horizontal */
            }
            .table-container {
                overflow: visible !important;
                width: 100%;
                min-width: 100%;
            }
            table {
                width: 100% !important;
                page-break-inside: auto;
            }
            tr {
                page-break-inside: avoid;
                page-break-after: auto;
            }
            thead {
                display: table-header-group;
            }
        }
        /* Estilos generales */
        th {
            background-color: #fef08a; /* Amarillo/Dorado */
            color: #4a148c; /* Violeta Oscuro */
            border-bottom: 2px solid #ddd;
            padding: 10px 12px;
            text-align: left;
            font-size: 11px;
        }
        td {
            padding: 8px 12px;
            font-size: 10px;
            border-bottom: 1px solid #f3f4f6;
            vertical-align: top;
            max-width: 250px; 
            min-width: 120px; 
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        /* Estilo espec√≠fico para la columna de numeraci√≥n */
        th:first-child, td:first-child {
            width: 50px; 
            min-width: 50px;
            max-width: 50px;
            text-align: center;
        }
    </style>
</head>
<body class="p-6 bg-gray-50">
    <header class="text-center mb-6">
        <h1 class="text-2xl font-bold text-gray-700">Ministerio de la Mujer - Informe de Perfiles (Datos Reales)</h1>
        <p class="text-sm text-gray-500">Listado de todos los registros de la base de datos de Firestore. (Total: <span id="recordCountDisplay">...</span>)</p>
    </header>
    <div class="no-print text-center mb-6">
        <button onclick="window.print()" class="bg-violet-600 hover:bg-violet-700 text-white font-bold py-3 px-6 rounded-lg transition-colors whitespace-nowrap shadow-md">
            üìÑ Generar PDF / Imprimir Informe
        </button>
        <p class="mt-2 text-xs text-gray-600">Al hacer clic, en el di√°logo de impresi√≥n, selecciona **"Guardar como PDF"** y **Orientaci√≥n Horizontal**.</p>
    </div>
    <div id="loadingIndicator" class="text-center py-10 text-violet-600 font-semibold text-lg no-print">
        Cargando datos reales de la base de datos... ‚è≥
    </div>
    <div class="table-container overflow-x-auto shadow-xl rounded-lg bg-white">
        <table class="min-w-full border-collapse">
            <thead>
                <tr>
                    <th>N¬∞</th> <th>Artesana Nombre</th>
                    <th>Emprendimiento Nombre</th>
                    <th>Tel√©fono</th>
                    <th>Ubicaci√≥n (50 Ch.)</th>
                    <th>Instagram</th>
                    <th>Descripci√≥n (50 Ch.)</th>
                    <th>Producto 1 (50 Ch.)</th>
                    <th>Producto 2 (50 Ch.)</th>
                    <th>Fecha Creaci√≥n</th>
                </tr>
            </thead>
            <tbody id="tableBody">
            </tbody>
        </table>
    </div>
    <p class="mt-4 text-xs text-gray-600">**Nota:** Todos los campos de texto largo (Ubicaci√≥n y Descripciones) est√°n limitados a **50 caracteres**.</p>
</body>
</html>
