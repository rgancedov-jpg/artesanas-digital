<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Panel de Administraci√≥n</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
        import { getFirestore, collection, doc, getDoc, query, getDocs, orderBy, startAfter, limit, where, deleteDoc } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

        // =================================================================================
        // ATENCI√ìN: REEMPLAZA LOS VALORES CON TU CONFIGURACI√ìN REAL DE FIREBASE
        // Mismos valores que en index.html
        // =================================================================================
        const firebaseConfig = {
            apiKey: "AIzaSyAVzAro7RdogHAkW1R8VTjVpNhi7cCSXZY", 
            authDomain: "artesanas-panama-digital.firebaseapp.com", 
            projectId: "artesanas-panama-digital", 
            storageBucket: "artesanas-panama-digital.firebasestorage.app", 
            messagingSenderId: "216158084302", 
            appId: "1:216158084302:web:e3c38b4a1a7234c7a8449f", 
            measurementId: "G-SQPMWH7G50" 
        };
        // =================================================================================
        
        // Inicializar Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const perfilesRef = collection(db, "perfiles");

        // Estado global para la navegaci√≥n y paginaci√≥n
        let lastVisible = null;
        let currentPage = 0;
        const PAGE_SIZE = 10;
        let allRecords = []; // Almacena todos los IDs de los registros cargados para la navegaci√≥n secuencial
        let currentRecordIndex = -1; 
        
        // Elementos del DOM
        const tableBody = document.getElementById('tableBody');
        const detailPanel = document.getElementById('detailPanel');
        const searchInput = document.getElementById('searchInput');
        const searchType = document.getElementById('searchType');
        const prevPageBtn = document.getElementById('prevPage');
        const nextPageBtn = document.getElementById('nextPage');
        const navPrevBtn = document.getElementById('navPrev');
        const navNextBtn = document.getElementById('navNext');
        const loadingIndicator = document.getElementById('loadingIndicator');

        // ======================== FUNCIONES DE NAVEGACI√ìN Y CARGA ========================

        /**
         * Carga los registros de la base de datos con paginaci√≥n.
         * @param {string} direction - 'next', 'prev', o 'initial'
         */
        window.loadRecords = async function (direction = 'initial') {
            loadingIndicator.classList.remove('hidden');
            let q;
            let firstVisible = null;

            try {
                // 1. Definir la consulta
                if (direction === 'next' && lastVisible) {
                    q = query(perfilesRef, orderBy("nombreEmprendimiento"), startAfter(lastVisible), limit(PAGE_SIZE));
                } else if (direction === 'initial' || direction === 'prev' || !lastVisible) {
                    // Para 'initial' (o si falla 'prev')
                    q = query(perfilesRef, orderBy("nombreEmprendimiento"), limit(PAGE_SIZE));
                }

                const documentSnapshots = await getDocs(q);
                
                if (documentSnapshots.empty && direction !== 'initial') {
                    alert("No hay m√°s registros para mostrar.");
                    loadingIndicator.classList.add('hidden');
                    return;
                }
                
                // 2. Actualizar la tabla y el estado de paginaci√≥n
                tableBody.innerHTML = '';
                allRecords = [];
                
                documentSnapshots.forEach(doc => {
                    const data = doc.data();
                    data.docId = doc.id; // A√±adir ID para la navegaci√≥n
                    allRecords.push(doc.id);

                    const row = tableBody.insertRow();
                    row.className = 'cursor-pointer hover:bg-violet-50 transition-colors';
                    row.onclick = () => selectRecord(doc.id, doc.data());
                    
                    row.insertCell().textContent = data.codigoSecuencial || 'N/A';
                    row.insertCell().textContent = data.nombreEmprendimiento || 'Sin Nombre';
                    row.insertCell().textContent = data.nombre || 'N/A';
                    row.insertCell().textContent = data.telefono || 'N/A';
                    row.insertCell().textContent = data.ubicacion || 'N/A';
                    
                    // Bot√≥n para borrar directamente desde la tabla (para administradores)
                    const actionsCell = row.insertCell();
                    const deleteBtn = document.createElement('button');
                    deleteBtn.textContent = 'üóëÔ∏è Borrar';
                    deleteBtn.className = 'bg-red-500 hover:bg-red-700 text-white font-bold py-1 px-3 rounded text-xs';
                    deleteBtn.onclick = (e) => {
                        e.stopPropagation(); // Evitar que se cargue el detalle
                        borrarRegistro(doc.id, data.codigoSecuencial);
                    };
                    actionsCell.appendChild(deleteBtn);
                });

                // 3. Actualizar cursores para la siguiente y anterior p√°gina
                if (!documentSnapshots.empty) {
                    lastVisible = documentSnapshots.docs[documentSnapshots.docs.length - 1];
                    firstVisible = documentSnapshots.docs[0];
                    if (direction === 'next') currentPage++;
                    if (direction === 'prev' && currentPage > 0) currentPage--;
                    if (direction === 'initial') currentPage = 0;
                }
                
                document.getElementById('pageStatus').textContent = `P√°gina ${currentPage + 1}`;
                prevPageBtn.disabled = currentPage === 0;
                nextPageBtn.disabled = documentSnapshots.empty || documentSnapshots.size < PAGE_SIZE;

            } catch (error) {
                console.error("Error cargando registros:", error);
                alert("Ocurri√≥ un error al cargar la lista de perfiles.");
            } finally {
                loadingIndicator.classList.add('hidden');
            }
        };
        
        /**
         * Realiza una b√∫squeda por C√≥digo Amigable o Nombre del Emprendimiento.
         */
        window.searchRecords = async function () {
            const searchTerm = searchInput.value.trim();
            const field = searchType.value; // 'codigoSecuencial' o 'nombreEmprendimiento'

            if (!searchTerm) {
                loadRecords('initial'); // Si est√° vac√≠o, recarga la lista
                return;
            }

            loadingIndicator.classList.remove('hidden');
            
            try {
                // La b√∫squeda por texto parcial es dif√≠cil en Firestore. Usaremos '=='
                const q = query(perfilesRef, where(field, '==', searchTerm.toUpperCase()));
                const querySnapshot = await getDocs(q);

                tableBody.innerHTML = '';
                allRecords = [];
                
                if (querySnapshot.empty) {
                    const row = tableBody.insertRow();
                    row.insertCell(0).textContent = 'No se encontraron resultados.';
                    row.cells[0].colSpan = 6;
                    row.cells[0].className = 'text-center py-4';
                } else {
                    querySnapshot.forEach(doc => {
                        const data = doc.data();
                        data.docId = doc.id;
                        allRecords.push(doc.id); // Guardar resultados de b√∫squeda para navegaci√≥n

                        const row = tableBody.insertRow();
                        row.className = 'cursor-pointer hover:bg-violet-50 transition-colors';
                        row.onclick = () => selectRecord(doc.id, doc.data());
                        
                        row.insertCell().textContent = data.codigoSecuencial || 'N/A';
                        row.insertCell().textContent = data.nombreEmprendimiento || 'Sin Nombre';
                        row.insertCell().textContent = data.nombre || 'N/A';
                        row.insertCell().textContent = data.telefono || 'N/A';
                        row.insertCell().textContent = data.ubicacion || 'N/A';
                        
                        const actionsCell = row.insertCell();
                        const deleteBtn = document.createElement('button');
                        deleteBtn.textContent = 'üóëÔ∏è Borrar';
                        deleteBtn.className = 'bg-red-500 hover:bg-red-700 text-white font-bold py-1 px-3 rounded text-xs';
                        deleteBtn.onclick = (e) => {
                            e.stopPropagation();
                            borrarRegistro(doc.id, data.codigoSecuencial);
                        };
                        actionsCell.appendChild(deleteBtn);
                    });
                }
                document.getElementById('pageStatus').textContent = `Resultados (${querySnapshot.size})`;
                prevPageBtn.disabled = true;
                nextPageBtn.disabled = true;

            } catch (error) {
                console.error("Error en la b√∫squeda:", error);
                alert("Ocurri√≥ un error al realizar la b√∫squeda.");
            } finally {
                loadingIndicator.classList.add('hidden');
            }
        };

        /**
         * Carga el detalle del registro seleccionado en el panel lateral.
         * @param {string} docId - ID del documento de Firestore.
         * @param {object} data - Datos del documento.
         */
        function selectRecord(docId, data) {
            currentRecordIndex = allRecords.findIndex(id => id === docId);

            document.getElementById('detailCodigo').textContent = data.codigoSecuencial || 'N/A';
            document.getElementById('detailEmprendimiento').textContent = data.nombreEmprendimiento || 'Sin Nombre';
            document.getElementById('detailEmprendedora').textContent = data.nombre || 'N/A';
            document.getElementById('detailTelefono').textContent = data.telefono || 'N/A';
            document.getElementById('detailUbicacion').textContent = data.ubicacion || 'N/A';
            document.getElementById('detailInstagram').textContent = data.instagram || 'N/A';
            document.getElementById('detailDescripcion').textContent = data.descripcion || 'Sin descripci√≥n';
            document.getElementById('detailCreatedAt').textContent = new Date(data.createdAt).toLocaleDateString() || 'N/A';
            
            // L√≥gica de im√°genes (solo muestra URL si existe)
            document.getElementById('detailLogo').innerHTML = data.logoURL ? `<p class="text-xs text-gray-500 truncate">Logo URL: <a href="${data.logoURL}" target="_blank" class="text-blue-500 hover:underline">${data.logoURL.substring(0, 30)}...</a></p>` : 'Sin Logo Subido';
            
            const prod1 = data.productos?.[0];
            const prod2 = data.productos?.[1];

            document.getElementById('detailProd1').innerHTML = `
                <p><strong>Desc:</strong> ${prod1?.descripcion || 'N/A'}</p>
                <p class="text-xs text-gray-500 truncate">URL: ${prod1?.url ? `<a href="${prod1.url}" target="_blank" class="text-blue-500 hover:underline">${prod1.url.substring(0, 30)}...</a>` : 'N/A'}</p>
            `;
            document.getElementById('detailProd2').innerHTML = `
                <p><strong>Desc:</strong> ${prod2?.descripcion || 'N/A'}</p>
                <p class="text-xs text-gray-500 truncate">URL: ${prod2?.url ? `<a href="${prod2.url}" target="_blank" class="text-blue-500 hover:underline">${prod2.url.substring(0, 30)}...</a>` : 'N/A'}</p>
            `;

            detailPanel.classList.remove('hidden');
            
            updateNavigationButtons();
        }

        /**
         * Actualiza los botones de navegaci√≥n secuencial.
         */
        function updateNavigationButtons() {
            navPrevBtn.disabled = currentRecordIndex <= 0;
            navNextBtn.disabled = currentRecordIndex >= allRecords.length - 1;
        }

        /**
         * Navega al registro anterior/siguiente en el conjunto de registros cargados.
         * @param {number} offset - -1 para anterior, 1 para siguiente.
         */
        window.navigateRecord = async function (offset) {
            const newIndex = currentRecordIndex + offset;
            
            if (newIndex >= 0 && newIndex < allRecords.length) {
                const docId = allRecords[newIndex];
                
                // Cargar el detalle del documento
                const docSnap = await getDoc(doc(perfilesRef, docId));
                if (docSnap.exists()) {
                    selectRecord(docId, docSnap.data());
                } else {
                    alert('Error: El registro no existe.');
                    loadRecords('initial'); // Recargar la lista
                }
            }
        }
        
        /**
         * Elimina un registro de la base de datos (Admin CRUD).
         * @param {string} docId - ID del documento.
         * @param {string} codigoSecuencial - C√≥digo amigable para confirmaci√≥n.
         */
        async function borrarRegistro(docId, codigoSecuencial) {
            if (!confirm(`‚ö†Ô∏è ¬øEst√° seguro que desea BORRAR PERMANENTEMENTE el registro ${codigoSecuencial}? Esta acci√≥n es irreversible.`)) {
                return;
            }

            try {
                await deleteDoc(doc(perfilesRef, docId));
                alert(`‚úÖ El registro ${codigoSecuencial} ha sido borrado exitosamente.`);
                
                // Recargar la lista y ocultar el panel de detalle
                loadRecords('initial');
                detailPanel.classList.add('hidden');
            } catch (error) {
                console.error("Error al borrar el registro:", error);
                alert(`‚ùå Ocurri√≥ un error al intentar borrar el registro: ${error.message}`);
            }
        }

        // ======================== INICIALIZACI√ìN ========================

        window.onload = function() {
            // Carga inicial de la primera p√°gina
            loadRecords('initial'); 
            
            // Configurar botones de paginaci√≥n
            prevPageBtn.onclick = () => loadRecords('prev');
            nextPageBtn.onclick = () => loadRecords('next');
            
            // Configurar botones de navegaci√≥n secuencial
            navPrevBtn.onclick = () => navigateRecord(-1);
            navNextBtn.onclick = () => navigateRecord(1);
            
            // Configurar b√∫squeda
            document.getElementById('searchButton').onclick = searchRecords;
        };
    </script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .header {
            background-color: #4a148c; /* Violeta oscuro */
            color: white;
        }
        .main-container {
            min-height: calc(100vh - 80px); /* Ajuste basado en el header */
        }
        th, td {
            padding: 12px 16px;
            text-align: left;
        }
        th {
            background-color: #fef08a; /* Amarillo claro (simulando Tailwind amber-100) */
            color: #4a148c;
            border-bottom: 2px solid #ddd;
        }
        .table-container {
            overflow-x: auto;
            min-width: 100%;
        }
        .detail-card {
            background-color: #fff;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .detail-item {
            border-bottom: 1px solid #eee;
            padding: 10px 0;
        }
    </style>
</head>
<body class="p-0">
    <header class="header p-4 shadow-lg">
        <h1 class="text-3xl font-extrabold">üöÄ Panel de Gesti√≥n (Administraci√≥n)</h1>
        <p class="text-sm">Vista de tabla y detalles de Perfiles Digitales.</p>
    </header>

    <div class="main-container flex flex-col lg:flex-row p-6 gap-6">

        <!-- Columna Principal: B√∫squeda y Tabla -->
        <div class="lg:w-2/3 w-full bg-white p-6 rounded-lg shadow-xl">
            <h2 class="text-xl font-bold text-gray-700 mb-4">Cat√°logo de Perfiles</h2>

            <!-- B√∫squeda -->
            <div class="flex flex-col sm:flex-row gap-3 mb-6">
                <select id="searchType" class="p-3 border rounded-lg focus:ring-violet-500 focus:border-violet-500">
                    <option value="codigoSecuencial">C√≥digo Amigable</option>
                    <option value="nombreEmprendimiento">Emprendimiento</option>
                </select>
                <input type="text" id="searchInput" placeholder="Buscar..." class="p-3 border rounded-lg flex-grow" />
                <button id="searchButton" class="bg-violet-600 hover:bg-violet-700 text-white font-bold py-3 px-6 rounded-lg transition-colors">
                    üîç Buscar
                </button>
            </div>

            <!-- Tabla de Registros -->
            <div class="table-container">
                <table class="w-full border-collapse rounded-lg overflow-hidden">
                    <thead>
                        <tr>
                            <th>C√≥digo</th>
                            <th>Emprendimiento</th>
                            <th>Emprendedora</th>
                            <th>Tel√©fono</th>
                            <th>Ubicaci√≥n</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <tr><td colspan="6" class="text-center py-4 text-gray-500">Cargando datos...</td></tr>
                    </tbody>
                </table>
            </div>

            <!-- Paginaci√≥n -->
            <div class="flex justify-between items-center mt-6">
                <button id="prevPage" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-l-lg" disabled>
                    P√°gina Anterior
                </button>
                <span id="pageStatus" class="text-gray-600 font-medium">P√°gina 1</span>
                <button id="nextPage" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-r-lg" disabled>
                    P√°gina Siguiente
                </button>
            </div>
            
            <div id="loadingIndicator" class="hidden text-center mt-4 text-violet-600 font-semibold">
                Cargando...
            </div>
        </div>

        <!-- Columna de Detalle (Panel Derecho) -->
        <div id="detailPanel" class="lg:w-1/3 w-full detail-card p-6 rounded-lg shadow-xl hidden">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h2 class="text-xl font-bold text-violet-800">Detalle del Perfil</h2>
                <span id="detailCodigo" class="bg-yellow-300 text-yellow-900 font-extrabold px-3 py-1 rounded-full text-sm"></span>
            </div>

            <!-- Navegaci√≥n Secuencial -->
            <div class="flex justify-between items-center mb-6">
                <button id="navPrev" class="bg-gray-200 hover:bg-gray-300 text-gray-800 py-1 px-3 rounded transition-colors text-sm" disabled>
                    &larr; Anterior
                </button>
                <span class="text-sm font-medium text-gray-600">Navegaci√≥n</span>
                <button id="navNext" class="bg-gray-200 hover:bg-gray-300 text-gray-800 py-1 px-3 rounded transition-colors text-sm" disabled>
                    Siguiente &rarr;
                </button>
            </div>

            <div class="space-y-3">
                <div class="detail-item">
                    <p class="font-semibold text-gray-700">Emprendimiento:</p>
                    <p id="detailEmprendimiento" class="text-gray-900"></p>
                </div>
                <div class="detail-item">
                    <p class="font-semibold text-gray-700">Emprendedora:</p>
                    <p id="detailEmprendedora" class="text-gray-900"></p>
                </div>
                <div class="detail-item">
                    <p class="font-semibold text-gray-700">Tel√©fono:</p>
                    <p id="detailTelefono" class="text-gray-900"></p>
                </div>
                <div class="detail-item">
                    <p class="font-semibold text-gray-700">Ubicaci√≥n:</p>
                    <p id="detailUbicacion" class="text-gray-900"></p>
                </div>
                <div class="detail-item">
                    <p class="font-semibold text-gray-700">Instagram:</p>
                    <p id="detailInstagram" class="text-gray-900"></p>
                </div>
                <div class="detail-item">
                    <p class="font-semibold text-gray-700">Descripci√≥n:</p>
                    <p id="detailDescripcion" class="text-gray-900 text-sm italic"></p>
                </div>
                <div class="detail-item">
                    <p class="font-semibold text-gray-700">Creado:</p>
                    <p id="detailCreatedAt" class="text-gray-500 text-sm"></p>
                </div>
                
                <h3 class="text-md font-bold text-gray-700 pt-3">Archivos Subidos (URLs)</h3>
                <div class="detail-item" id="detailLogo">
                    <!-- Logo URL -->
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div class="detail-item border-none" id="detailProd1">
                        <p class="font-semibold text-gray-700">Producto 1:</p>
                    </div>
                    <div class="detail-item border-none" id="detailProd2">
                        <p class="font-semibold text-gray-700">Producto 2:</p>
                    </div>
                </div>

            </div>
        </div>
    </div>
</body>
</html>
